syntax = "proto3";

package desam.client;

// 通用响应消息
message CommonResponse {
  bool success = 1;
  string message = 2;
  string error_code = 3;
}

// 作业状态枚举
enum JobStatus {
  UNKNOWN = 0;
  QUEUED = 1;          // 等待队列
  PREPARING = 2;       // 准备中
  RUNNING = 3;         // 执行中
  SUCCEEDED = 4;       // 成功
  FAILED = 5;          // 失败
  CANCELLED = 6;       // 已取消
  TIMEOUT = 7;         // 超时
}

// 资源需求
message ResourceRequirement {
  int32 cpu_cores = 1;     // CPU核心数
  int64 memory_mb = 2;     // 内存(MB)
  int32 gpu_count = 3;     // GPU数量
  int64 disk_mb = 4;       // 磁盘空间(MB)
}

// 数据依赖
message DataDependency {
  string source_path = 1;   // 源路径
  string dest_path = 2;     // 目标路径
  bool is_input = 3;        // 是否为输入数据
}

// 作业信息
message Job {
  string job_id = 1;           // 作业ID
  string user_id = 2;          // 用户ID
  string name = 3;             // 作业名称
  string command = 4;          // 执行命令
  string working_dir = 5;      // 工作目录
  ResourceRequirement resources = 6;  // 资源需求
  repeated DataDependency dependencies = 7;  // 数据依赖
  map<string, string> metadata = 8;  // 元数据
  int64 submit_time = 9;       // 提交时间戳
  int64 start_time = 10;       // 开始时间戳
  int64 finish_time = 11;      // 完成时间戳
  JobStatus status = 12;       // 当前状态
  string error_message = 13;   // 错误信息
  string executor_id = 14;     // 分配的执行器ID
  // 新增字段
  map<string, string> env = 15;       // 环境变量
  int32 timeout = 16;                  // 超时时间(秒)
  int32 retries = 17;                  // 重试次数
  repeated string artifacts = 18;      // 数据依赖(逻辑文件名)
  map<string, string> labels = 19;     // 标签
  string description = 20;             // 描述
}

// 作业提交请求
message SubmitJobRequest {
  string api_key = 1;          // API密钥
  string user_id = 2;          // 用户ID
  string name = 3;             // 作业名称
  string command = 4;          // 执行命令
  string working_dir = 5;      // 工作目录
  ResourceRequirement resources = 6;  // 资源需求
  repeated DataDependency dependencies = 7;  // 数据依赖
  map<string, string> metadata = 8;  // 元数据
  // 新增字段
  map<string, string> env = 9;        // 环境变量
  int32 timeout = 10;                  // 超时时间(秒)
  int32 retries = 11;                  // 重试次数
  repeated string artifacts = 12;      // 数据依赖(逻辑文件名)
  map<string, string> labels = 13;     // 标签
  string description = 14;             // 描述
}

// 作业提交响应
message SubmitJobResponse {
  CommonResponse response = 1;  // 通用响应
  string job_id = 2;            // 分配的作业ID
  Job job = 3;                  // 作业信息
}

// 作业查询请求
message QueryJobRequest {
  string api_key = 1;          // API密钥
  string job_id = 2;           // 作业ID
}

// 作业查询响应
message QueryJobResponse {
  CommonResponse response = 1;  // 通用响应
  Job job = 2;                  // 作业信息
}

// 作业取消请求
message CancelJobRequest {
  string api_key = 1;          // API密钥
  string job_id = 2;           // 作业ID
}

// 作业取消响应
message CancelJobResponse {
  CommonResponse response = 1;  // 通用响应
  Job job = 2;                  // 更新后的作业信息
}

// 作业列表查询请求
message ListJobsRequest {
  string api_key = 1;          // API密钥
  string user_id = 2;          // 用户ID（可选，空则查询所有）
  JobStatus status = 3;        // 状态过滤（可选）
  int32 limit = 4;             // 限制数量（默认100）
  int32 offset = 5;            // 偏移量（分页）
}

// 作业列表查询响应
message ListJobsResponse {
  CommonResponse response = 1;  // 通用响应
  repeated Job jobs = 2;         // 作业列表
  int32 total = 3;              // 总数
}

// 作业日志请求
message GetJobLogsRequest {
  string api_key = 1;          // API密钥
  string job_id = 2;           // 作业ID
  int64 from_line = 3;         // 从第几行开始（默认0）
  int64 max_lines = 4;         // 最大行数（默认1000）
}

// 作业日志响应
message GetJobLogsResponse {
  CommonResponse response = 1;  // 通用响应
  string log_content = 2;       // 日志内容
  int64 total_lines = 3;        // 总行数
}

// 批量查询请求
message BatchQueryJobsRequest {
  string api_key = 1;          // API密钥
  repeated string job_ids = 2; // 作业ID列表
}

// 批量取消请求
message BatchCancelJobsRequest {
  string api_key = 1;          // API密钥
  repeated string job_ids = 2; // 作业ID列表
}

// 批量取消响应中的单个结果
message CancelResult {
  string job_id = 1;           // 作业ID
  bool success = 2;            // 是否成功
  string message = 3;          // 结果消息
}

// 批量取消响应
message BatchCancelJobsResponse {
  CommonResponse response = 1;      // 通用响应
  repeated CancelResult results = 2; // 各作业取消结果
}

// Client服务定义
service ClientService {
  // 提交作业
  rpc SubmitJob(SubmitJobRequest) returns (SubmitJobResponse);

  // 查询作业状态
  rpc QueryJob(QueryJobRequest) returns (QueryJobResponse);

  // 取消作业
  rpc CancelJob(CancelJobRequest) returns (CancelJobResponse);

  // 列出作业
  rpc ListJobs(ListJobsRequest) returns (ListJobsResponse);

  // 获取作业日志
  rpc GetJobLogs(GetJobLogsRequest) returns (GetJobLogsResponse);

  // 批量查询作业
  rpc BatchQueryJobs(BatchQueryJobsRequest) returns (ListJobsResponse);

  // 批量取消作业
  rpc BatchCancelJobs(BatchCancelJobsRequest) returns (BatchCancelJobsResponse);
}
